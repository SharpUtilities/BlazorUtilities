@* SessionState.Examples/Components/Pages/EventsDemo.razor *@
@page "/events-demo"
@using SessionState.Core
@using SessionState.Core.Events
@using SessionState.Examples.SessionStates
@implements IDisposable

<PageTitle>Events Demo - SessionState</PageTitle>

<h1>Events Demo</h1>
<p class="lead">Demonstrates global and instance-level events.</p>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5>Trigger Events</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <h6>Counter State</h6>
                    <div class="btn-group">
                        <button class="btn btn-outline-primary" @onclick="SetCounter">Set</button>
                        <button class="btn btn-outline-secondary" @onclick="ModifyCounter">Modify</button>
                        <button class="btn btn-outline-warning" @onclick="RefreshCounter">Refresh</button>
                        <button class="btn btn-outline-danger" @onclick="ClearCounter">Clear</button>
                    </div>
                </div>

                <div class="mb-3">
                    <h6>User Preferences</h6>
                    <div class="btn-group">
                        <button class="btn btn-outline-primary" @onclick="SetPreferences">Set</button>
                        <button class="btn btn-outline-secondary" @onclick="ModifyPreferences">Modify</button>
                        <button class="btn btn-outline-danger" @onclick="ClearPreferences">Clear</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h5>Instance Events (Counter)</h5>
            </div>
            <div class="card-body" style="max-height: 200px; overflow-y: auto;">
                @foreach (var evt in _instanceEvents.TakeLast(10).Reverse())
                {
                    <div class="small mb-1">
                        <span class="badge bg-primary">@evt.Time.ToString("HH:mm:ss")</span>
                        @evt.Message
                    </div>
                }
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5>Global Events (All Types)</h5>
            </div>
            <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                @foreach (var evt in _globalEvents.TakeLast(20).Reverse())
                {
                    <div class="small mb-2">
                        <div>
                            <span class="badge @GetEventBadgeClass(evt.EventType)">@evt.EventType</span>
                            <span class="text-muted">@evt.Time.ToString("HH:mm:ss.fff")</span>
                        </div>
                        <div><strong>Type:</strong> @evt.StateType</div>
                        <div><strong>Key:</strong> @evt.SessionKey</div>
                        @if (!string.IsNullOrEmpty(evt.Details))
                        {
                            <div class="text-muted">@evt.Details</div>
                        }
                    </div>
                }
            </div>
            <div class="card-footer">
                <button class="btn btn-sm btn-outline-secondary" @onclick="ClearEvents">Clear All</button>
            </div>
        </div>
    </div>
</div>

@code {
    [Inject] private SessionState<CounterState> Counter { get; set; } = default!;
    [Inject] private SessionState<UserPreferences> Preferences { get; set; } = default!;
    [Inject] private ISessionStateEventDispatcher EventDispatcher { get; set; } = default!;

    private readonly List<EventLog> _globalEvents = new();
    private readonly List<EventLog> _instanceEvents = new();

    protected override void OnInitialized()
    {
        Counter.Changed += OnCounterChanged;

        EventDispatcher.ValueSet += OnValueSet;
        EventDispatcher.ValueCleared += OnValueCleared;
        EventDispatcher.ValueRefreshed += OnValueRefreshed;
        EventDispatcher.ValueChanged += OnValueChanged;
        EventDispatcher.BackendOperation += OnBackendOperation;
    }

    private void OnCounterChanged(object? sender, SessionStateChangedEventArgs<CounterState> e)
    {
        _instanceEvents.Add(new EventLog
        {
            Time = DateTime.Now,
            EventType = e.ChangeType.ToString(),
            StateType = "CounterState",
            SessionKey = "-",
            Message = $"{e.ChangeType}: {e.Value?.Count}"
        });
        InvokeAsync(StateHasChanged);
    }

    private void OnValueSet(object? sender, SessionStateValueSetEventArgs e)
    {
        _globalEvents.Add(new EventLog
        {
            Time = DateTime.Now,
            EventType = "ValueSet",
            StateType = e.StateType.Name,
            SessionKey = FormatKey(e.SessionKey),
            Details = $"IsUpdate: {e.IsUpdate}"
        });
        InvokeAsync(StateHasChanged);
    }

    private void OnValueCleared(object? sender, SessionStateValueClearedEventArgs e)
    {
        _globalEvents.Add(new EventLog
        {
            Time = DateTime.Now,
            EventType = "ValueCleared",
            StateType = e.StateType.Name,
            SessionKey = FormatKey(e.SessionKey),
            Details = $"Had previous: {e.PreviousValue is not null}"
        });
        InvokeAsync(StateHasChanged);
    }

    private void OnValueRefreshed(object? sender, SessionStateValueRefreshedEventArgs e)
    {
        _globalEvents.Add(new EventLog
        {
            Time = DateTime.Now,
            EventType = "ValueRefreshed",
            StateType = e.StateType.Name,
            SessionKey = FormatKey(e.SessionKey)
        });
        InvokeAsync(StateHasChanged);
    }

    private void OnValueChanged(object? sender, SessionStateValueChangedEventArgs e)
    {
        _globalEvents.Add(new EventLog
        {
            Time = DateTime.Now,
            EventType = "ValueChanged",
            StateType = e.StateType.Name,
            SessionKey = FormatKey(e.SessionKey),
            Details = $"Property: {e.PropertyName}"
        });
        InvokeAsync(StateHasChanged);
    }

    private void OnBackendOperation(object? sender, SessionStateBackendEventArgs e)
    {
        _globalEvents.Add(new EventLog
        {
            Time = DateTime.Now,
            EventType = $"Backend:{e.Operation}",
            StateType = e.StateType.Name,
            SessionKey = FormatKey(e.SessionKey)
        });
        InvokeAsync(StateHasChanged);
    }

    private async Task SetCounter()
    {
        await Counter.SetAsync(new CounterState { Count = Random.Shared.Next(1, 100) });
    }

    private void ModifyCounter()
    {
        if (Counter.HasValue)
        {
            Counter.Value!.Count += 10;
        }
    }

    private async Task RefreshCounter()
    {
        await Counter.RefreshAsync();
    }

    private async Task ClearCounter()
    {
        await Counter.ClearAsync();
    }

    private async Task SetPreferences()
    {
        await Preferences.SetAsync(new UserPreferences { Theme = "dark", Language = "en" });
    }

    private void ModifyPreferences()
    {
        if (Preferences.HasValue)
        {
            Preferences.Value!.FontSize = Random.Shared.Next(12, 24);
        }
    }

    private async Task ClearPreferences()
    {
        await Preferences.ClearAsync();
    }

    private void ClearEvents()
    {
        _globalEvents.Clear();
        _instanceEvents.Clear();
    }

    private string FormatKey(string key) => key.Length > 8 ? key[..8] + "..." : key;

    private string GetEventBadgeClass(string eventType) => eventType switch
    {
        "ValueSet" => "bg-success",
        "ValueCleared" => "bg-danger",
        "ValueRefreshed" => "bg-info",
        "ValueChanged" => "bg-warning text-dark",
        _ when eventType.StartsWith("Backend:") => "bg-secondary",
        _ => "bg-dark"
    };

    public void Dispose()
    {
        Counter.Changed -= OnCounterChanged;
        EventDispatcher.ValueSet -= OnValueSet;
        EventDispatcher.ValueCleared -= OnValueCleared;
        EventDispatcher.ValueRefreshed -= OnValueRefreshed;
        EventDispatcher.ValueChanged -= OnValueChanged;
        EventDispatcher.BackendOperation -= OnBackendOperation;
    }

    private record EventLog
    {
        public DateTime Time { get; init; }
        public required string EventType { get; init; }
        public required string StateType { get; init; }
        public required string SessionKey { get; init; }
        public string? Message { get; init; }
        public string? Details { get; init; }
    }
}
