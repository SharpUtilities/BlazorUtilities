@* SessionState.Examples/Components/Pages/PropertyTracking.razor *@
@page "/property-tracking"
@using SessionState.Core
@using SessionState.Examples.SessionStates
@implements IDisposable

<PageTitle>Property Tracking - SessionState</PageTitle>

<h1>Property Tracking</h1>
<p class="lead">Demonstrates automatic property change detection and persistence.</p>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5>User Preferences</h5>
            </div>
            <div class="card-body">
                @if (Preferences.HasValue)
                {
                    <div class="mb-3">
                        <label class="form-label">Theme</label>
                        <div class="btn-group d-block">
                            <button class="btn @(Preferences.Value!.Theme == "light" ? "btn-primary" : "btn-outline-primary")"
                                    @onclick="@(() => SetTheme("light"))">
                                ☀️ Light
                            </button>
                            <button class="btn @(Preferences.Value!.Theme == "dark" ? "btn-primary" : "btn-outline-primary")"
                                    @onclick="@(() => SetTheme("dark"))">
                                🌙 Dark
                            </button>
                            <button class="btn @(Preferences.Value!.Theme == "system" ? "btn-primary" : "btn-outline-primary")"
                                    @onclick="@(() => SetTheme("system"))">
                                💻 System
                            </button>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Language</label>
                        <select class="form-select" value="@Preferences.Value!.Language"
                                @onchange="OnLanguageChanged">
                            <option value="en">English</option>
                            <option value="es">Español</option>
                            <option value="fr">Français</option>
                            <option value="de">Deutsch</option>
                            <option value="ja">日本語</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Font Size: @Preferences.Value!.FontSize px</label>
                        <input type="range" class="form-range" min="12" max="24"
                               value="@Preferences.Value!.FontSize"
                               @onchange="OnFontSizeChanged" />
                    </div>

                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox"
                                   checked="@Preferences.Value!.NotificationsEnabled"
                                   @onchange="OnNotificationsChanged" />
                            <label class="form-check-label">Enable Notifications</label>
                        </div>
                    </div>
                }
                else
                {
                    <button class="btn btn-primary" @onclick="InitializePreferences">
                        Initialize Preferences
                    </button>
                }
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5>Change Log</h5>
            </div>
            <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                @if (_changeLog.Count == 0)
                {
                    <p class="text-muted">No changes recorded yet.</p>
                }
                else
                {
                    <ul class="list-unstyled small">
                        @foreach (var log in _changeLog.TakeLast(20).Reverse())
                        {
                            <li class="mb-1">
                                <span class="badge bg-info">@log.Time.ToString("HH:mm:ss")</span>
                                <span>@log.Property: @log.Description</span>
                            </li>
                        }
                    </ul>
                }
                <button class="btn btn-sm btn-outline-secondary" @onclick="ClearLog">Clear Log</button>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h5>How It Works</h5>
            </div>
            <div class="card-body small">
                <p>
                    When <code>TrackPropertyChanges</code> is enabled, SessionState
                    subscribes to <code>INotifyPropertyChanged</code> events on your state objects.
                </p>
                <p>
                    If <code>AutoPersistOnPropertyChange</code> is also enabled, changes are
                    automatically saved to the backend without calling <code>SetAsync</code>.
                </p>
            </div>
        </div>
    </div>
</div>

@code {
    [Inject] private SessionState<UserPreferences> Preferences { get; set; } = default!;

    private readonly List<ChangeLogEntry> _changeLog = new();

    protected override void OnInitialized()
    {
        Preferences.Changed += OnPreferencesChanged;
    }

    private void OnPreferencesChanged(object? sender, SessionStateChangedEventArgs<UserPreferences> e)
    {
        if (e.ChangeType == SessionStateChangeType.PropertyChanged && e.PropertyName is not null)
        {
            _changeLog.Add(new ChangeLogEntry
            {
                Time = DateTime.Now,
                Property = e.PropertyName,
                Description = $"Changed to {GetPropertyValue(e.PropertyName)}"
            });
        }
        else if (e.ChangeType == SessionStateChangeType.Set)
        {
            _changeLog.Add(new ChangeLogEntry
            {
                Time = DateTime.Now,
                Property = "State",
                Description = e.PreviousValue is null ? "Initialized" : "Updated"
            });
        }

        InvokeAsync(StateHasChanged);
    }

    private string GetPropertyValue(string propertyName)
    {
        return propertyName switch
        {
            nameof(UserPreferences.Theme) => Preferences.Value?.Theme ?? "?",
            nameof(UserPreferences.Language) => Preferences.Value?.Language ?? "?",
            nameof(UserPreferences.FontSize) => Preferences.Value?.FontSize.ToString() ?? "?",
            nameof(UserPreferences.NotificationsEnabled) => Preferences.Value?.NotificationsEnabled.ToString() ?? "?",
            _ => "?"
        };
    }

    private async Task InitializePreferences()
    {
        await Preferences.SetAsync(new UserPreferences());
    }

    private void SetTheme(string theme) => Preferences.Value!.Theme = theme;

    private void OnLanguageChanged(ChangeEventArgs e)
    {
        var value = e.Value?.ToString();
        if (!string.IsNullOrEmpty(value))
        {
            Preferences.Value!.Language = value;
        }
    }

    private void OnFontSizeChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var size))
        {
            Preferences.Value!.FontSize = size;
        }
    }

    private void OnNotificationsChanged(ChangeEventArgs e)
    {
        if (e.Value is bool enabled)
        {
            Preferences.Value!.NotificationsEnabled = enabled;
        }
    }

    private void ClearLog() => _changeLog.Clear();

    public void Dispose()
    {
        Preferences.Changed -= OnPreferencesChanged;
    }

    private record ChangeLogEntry
    {
        public DateTime Time { get; init; }
        public required string Property { get; init; }
        public required string Description { get; init; }
    }
}
