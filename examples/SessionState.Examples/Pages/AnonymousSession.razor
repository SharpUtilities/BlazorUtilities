@* SessionState.Examples/Components/Pages/AnonymousSession.razor *@
@page "/anonymous-session"
@using SessionState.Core
@using SessionState.Examples.SessionStates
@implements IDisposable

<PageTitle>Anonymous Session - SessionState</PageTitle>

<h1>Anonymous Session (Shopping Cart)</h1>
<p class="lead">Demonstrates cookie-based session state for anonymous users.</p>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Products</h5>
                <span class="badge bg-primary">
                    Cart: @(Cart.Value?.ItemCount ?? 0) items
                </span>
            </div>
            <div class="card-body">
                <div class="row">
                    @foreach (var product in _products)
                    {
                        <div class="col-md-4 mb-3">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <div class="fs-1 mb-2">@product.Emoji</div>
                                    <h6>@product.Name</h6>
                                    <p class="text-success fw-bold">$@product.Price.ToString("F2")</p>
                                    <button class="btn btn-sm btn-outline-primary"
                                            @onclick="@(() => AddToCart(product))">
                                        Add to Cart
                                    </button>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5>🛒 Shopping Cart</h5>
            </div>
            <div class="card-body">
                @if (Cart.HasValue && Cart.Value!.Items.Any())
                {
                    <ul class="list-group list-group-flush mb-3">
                        @foreach (var item in Cart.Value!.Items)
                        {
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>@item.Name x@item.Quantity</span>
                                <span>
                                    $@((item.Price * item.Quantity).ToString("F2"))
                                    <button class="btn btn-sm btn-link text-danger p-0 ms-2"
                                            @onclick="@(() => RemoveFromCart(item.Name))">
                                        ×
                                    </button>
                                </span>
                            </li>
                        }
                    </ul>

                    <div class="mb-3">
                        <input type="text" class="form-control form-control-sm"
                               placeholder="Coupon code"
                               value="@Cart.Value!.CouponCode"
                               @onchange="OnCouponChanged" />
                    </div>

                    <div class="d-flex justify-content-between fw-bold mb-3">
                        <span>Total:</span>
                        <span>$@Cart.Value!.Total.ToString("F2")</span>
                    </div>

                    <div class="d-grid gap-2">
                        <button class="btn btn-success">Checkout</button>
                        <button class="btn btn-outline-danger" @onclick="ClearCart">Clear Cart</button>
                    </div>
                }
                else
                {
                    <p class="text-muted text-center">Your cart is empty</p>
                }
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h5>How It Works</h5>
            </div>
            <div class="card-body small">
                <ol class="mb-3">
                    <li>First request: Middleware creates a session key</li>
                    <li>Key is encrypted and stored in a cookie</li>
                    <li>SignalR circuit captures the key on connect</li>
                    <li>All state operations use this captured key</li>
                    <li>Cookie persists across page refreshes</li>
                </ol>

                <div class="alert alert-info mb-0">
                    <strong>Try this:</strong> Add items to your cart, then refresh the page.
                    Your cart will still be there!
                </div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h5>Session Info</h5>
            </div>
            <div class="card-body small">
                <dl class="mb-0">
                    <dt>Storage</dt>
                    <dd>Encrypted cookie + In-memory backend</dd>
                    <dt>Sliding Expiration</dt>
                    <dd>30 minutes</dd>
                    <dt>Absolute Expiration</dt>
                    <dd>24 hours</dd>
                    <dt>Cookie Max Age</dt>
                    <dd>24 hours</dd>
                </dl>
            </div>
        </div>
    </div>
</div>

@code {
    [Inject] private SessionState<ShoppingCart> Cart { get; set; } = default!;

    private readonly List<Product> _products =
    [
        new("Coffee", 4.99m, "☕"),
        new("Pizza", 12.99m, "🍕"),
        new("Burger", 8.99m, "🍔"),
        new("Sushi", 15.99m, "🍣"),
        new("Salad", 7.99m, "🥗"),
        new("Ice Cream", 5.99m, "🍦")
    ];

    protected override async Task OnInitializedAsync()
    {
        Cart.Changed += OnCartChanged;

        if (!Cart.HasValue)
        {
            await Cart.SetAsync(new ShoppingCart());
        }
    }

    private void OnCartChanged(object? sender, SessionStateChangedEventArgs<ShoppingCart> e)
    {
        InvokeAsync(StateHasChanged);
    }

    private void AddToCart(Product product)
    {
        Cart.Value?.AddItem(product.Name, product.Price);
    }

    private void RemoveFromCart(string name)
    {
        Cart.Value?.RemoveItem(name);
    }

    private void OnCouponChanged(ChangeEventArgs e)
    {
        if (Cart.Value is not null)
        {
            Cart.Value.CouponCode = e.Value?.ToString() ?? string.Empty;
        }
    }

    private void ClearCart()
    {
        Cart.Value?.Clear();
    }

    public void Dispose()
    {
        Cart.Changed -= OnCartChanged;
    }

    private record Product(string Name, decimal Price, string Emoji);
}
